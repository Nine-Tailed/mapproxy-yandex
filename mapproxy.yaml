# mapproxy.yaml
# ВСЕ ПАРАМЕТРЫ ДОЛЖНЫ БЫТЬ НА ПРАВИЛЬНЫХ УРОВНЯХ (согласно документации 1.16.0)

# Глобальные настройки
globals:
  # ПРАВИЛЬНЫЙ ФОРМАТ ДЛЯ PROJ В 1.16.0 (вложенная структура)
  proj:
    use_pyproj: true
    data_dir: /usr/share/proj
  
  # ПРАВИЛЬНЫЙ ФОРМАТ ДЛЯ КЭША В 1.16.0
  cache:
    # max_tile_limit вместо max_tiles
    max_tile_limit:
      error: 800
      skip: 400
  
  # Настройки HTTP
  http:
    client_timeout: 20

# Настройка логирования (на том же уровне, что и globals)
logging:
  # Уровень логирования
  level: warning
  # Формат логов
  format: "%(asctime)s %(name)-12s %(levelname)-8s %(message)s"

# Сервисы
services:
  # ПРАВИЛЬНЫЙ ФОРМАТ ДЛЯ demo В 1.16.0
  demo:
    # Название и описание НАПРЯМУЮ (без md)
    title: Yandex Proxy
    abstract: Прокси для тайлов Яндекса в WGS84
  
  tms:
    # use_grid_names вместо origin
    use_grid_names: true
    origin: nw

# Слои
layers:
  - name: yandex
    title: Yandex Maps (WGS84)
    sources: [yandex_cache]

# Кэши
caches:
  yandex_cache:
    sources: [yandex_source]
    grids: [wgs84_grid]
    cache:
      type: file
      # directory вместо base_dir
      directory: /var/cache/mapproxy
      # lock_dir вместо lock_directory
      lock_dir: /var/cache/mapproxy/locks

# Источники
sources:
  yandex_source:
    type: tile
    url: https://core-renderer-tiles.maps.yandex.net/tiles?l=map&x=%(x)s&y=%(y)s&z=%(z)s&scale=1&lang=ru_RU
    http:
      headers:
        User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36"
        Referer: "https://yandex.ru/maps/"
        Accept-Language: "ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7"
    # grid должен быть веб-меркатором
    grid: web_mercator

# Сетки
grids:
  web_mercator:
    base: GLOBAL_MERCATOR
    
  wgs84_grid:
    srs: 'EPSG:4326'
    bbox: [-180, -90, 180, 90]
    num_levels: 15